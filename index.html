<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kæ­Œè–èª•ç¦®ç‰©è¶´ - æ¶éº¥å…¥å ´ï¼</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼å°åœ–ç¤º) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- è¼‰å…¥ é«˜ç´šè¥¯ç·šå­—é«”ï¼šPlayfair Display (ç”¨æ–¼æ¨™é¡Œ) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    
    <!-- è¼‰å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level
        setLogLevel('debug');

        // --- Firebase environment variables initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Check if config exists and is a string before parsing
        const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }

        let app, db, auth, userId = 'N/A (Initializing...)';

        // Mount necessary objects to global Window for JS access
        window.firebase = {
            init: async function() {
                // If config is empty, we still proceed to show the UI
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing. Data submission will be disabled.");
                    window.app.initLogic(false); // Force UI render, submission disabled
                    return;
                }

                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    window.db = db; // Mount Firestore instance

                    // Authentication flow
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            window.userId = userId;
                            console.log("Firebase Auth Ready. User ID:", userId);
                            // Auth ready, initialize app logic
                            window.app.initLogic(true);
                        } else {
                            // Should not happen often if sign-in is successful
                            console.warn("User is not signed in after auth attempt.");
                            window.app.initLogic(false);
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization Failed:", error);
                    window.app.initLogic(false); // Force UI render even on failure
                }
            },
            saveRegistration: async function(data) {
                if (!db || !window.userId) {
                    throw new Error("Firestore not initialized or user not authenticated. Submission aborted.");
                }

                const collectionPath = `artifacts/${appId}/public/data/party_registrations`;
                console.log("Saving data to:", collectionPath);

                const sanitizedData = {
                    ...data,
                    timestamp: new Date().toISOString(),
                    user_id: window.userId
                };

                try {
                    const docRef = await addDoc(collection(db, collectionPath), sanitizedData);
                    console.log("Document written with ID: ", docRef.id);
                    return docRef.id;
                } catch (e) {
                    console.error("Error adding document: ", e);
                    throw e;
                }
            }
        };

        // Application initialization
        window.app = {
            isSubmissionEnabled: false,
            // Flag 'authReady' is passed from firebase init
            initLogic: (authReady = false) => { 
                window.app.isSubmissionEnabled = authReady;
                // Force updatePage to draw UI immediately, regardless of auth status
                updatePage(); 
            }
        };

        // Start Firebase initialization on window load
        window.onload = () => {
            window.firebase.init();
        };

    </script>
    <style>
        /* ------------------------------------- */
        /* 1. å®šç¾©å¥¢è¯è–èª•é…è‰² (Luxury Jewel Tones) */
        /* ------------------------------------- */
        :root {
            --color-bg-main: #121212; /* æ¥µæ·±æœ¨ç‚­ */
            --color-bg-secondary: #332619; /* æš–èª¿æ·±æ£• */
            --color-text-cream: #FAF9F6; /* å¥¶æ²¹ç™½ */
            --color-gold-luxury: #D4AF37; /* å¥¢è¯æš–é‡‘ (Accent A) */
            --color-brass-antique: #A9853C; /* å¾©å¤é»ƒéŠ… (Accent B) */
            --color-danger: #930018; /* ç”¨æ–¼å¿…å¡«æ˜Ÿè™Ÿæˆ–éŒ¯èª¤è¨Šæ¯ */
        }

        /* è¨­ç½®å­—é«”èˆ‡å…¨åŸŸæ–‡å­—é¡è‰² */
        body {
            /* ä¸­æ–‡åŠå…§æ–‡å„ªå…ˆä½¿ç”¨æ˜“è®€çš„ Noto Sans TC / Inter */
            font-family: 'Noto Sans TC', 'Inter', system-ui, sans-serif;
            color: var(--color-text-cream);
        }

        /* é«˜ç´šè¥¯ç·šå­—é«”æ¨£å¼ (ç”¨æ–¼æ¨™é¡Œ) */
        .font-luxury-heading {
            /* ä½¿ç”¨ Playfair Display é€™ç¨®ç¶“å…¸è¥¯ç·šå­—é«”ä¾†ç‡Ÿé€ é«˜ç´šæ„Ÿ */
            font-family: 'Playfair Display', serif;
            font-weight: 700; /* åŠ ç²—ä»¥å¼·èª¿ */
        }

        /* ------------------------------------- */
        /* 2. èƒŒæ™¯èˆ‡é–ƒçˆæ˜Ÿæ˜Ÿå‹•ç•« (Twinkling Stars) */
        /* ------------------------------------- */
        .christmas-bg {
            /* Base color is deep charcoal */
            background-color: var(--color-bg-main); 
            /* Soft gradient mix with deep brown for texture */
            background: radial-gradient(circle at top left, var(--color-bg-secondary) 0%, transparent 70%),
                        radial-gradient(circle at bottom right, var(--color-bg-secondary) 0%, transparent 70%),
                        linear-gradient(135deg, var(--color-bg-main) 0%, #000000 100%); 
            background-blend-mode: overlay, overlay, normal;
            background-size: 400% 400%;
            animation: backgroundShift 20s ease infinite;
            overflow: hidden;
            position: relative;
        }

        @keyframes backgroundShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Twinkling stars style */
        .star-twinkle {
            position: absolute;
            width: 4px; /* Slightly increased size */
            height: 4px; /* Slightly increased size */
            border-radius: 50%;
            background: var(--color-text-cream); /* Cream white for star light */
            opacity: 0; /* Default hidden */
            box-shadow: 0 0 5px var(--color-text-cream); /* Subtle glow */
            filter: blur(0.5px); /* Slight blur for realism */
            pointer-events: none;
            /* Different animation delay and duration for each star */
            animation: twinkle 1.2s infinite alternate ease-in-out; 
        }

        /* Twinkle animation: change size and opacity */
        @keyframes twinkle {
            0% { transform: scale(0.3); opacity: 0; } 
            50% { transform: scale(1.5); opacity: 1; } 
            100% { transform: scale(0.6); opacity: 0.5; } 
        }

        /* ------------------------------------- */
        /* 3. ç»ç’ƒæ“¬æ…‹ (Glassmorphism) æ•ˆæœ */
        /* ------------------------------------- */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(35px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            /* Deep external shadow + subtle internal light glow */
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.7), 
                        inset 0 0 10px rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Glass card Hover effect */
        .glass-card:hover {
            /* Stronger external glow and golden border */
            box-shadow: 0 20px 80px 0 rgba(0, 0, 0, 0.95), 
                        0 0 20px 0 var(--color-gold-luxury); 
            border: 1px solid var(--color-gold-luxury);
            transform: translateY(-2px); 
        }
        
        /* ------------------------------------- */
        /* 4. è¼¸å…¥æ¡† (Input) äº’å‹•æ•ˆæœ */
        /* ------------------------------------- */
        .glass-input {
            background: none;
            border: none;
            border-bottom: 2px solid var(--color-brass-antique); /* Antique brass underline */
            color: var(--color-text-cream);
            transition: border-bottom-color 0.4s ease, box-shadow 0.4s ease;
        }

        /* Focus: Antique brass -> Luxury gold glow */
        .glass-input:focus {
            outline: none;
            border-bottom-color: var(--color-gold-luxury);
            box-shadow: 0 1px 0 0 var(--color-gold-luxury), 0 0 5px var(--color-gold-luxury);
        }
        
        /* Checkbox/Radio style */
        .glass-check {
            accent-color: var(--color-gold-luxury);
            border-color: var(--color-brass-antique);
        }

        /* ------------------------------------- */
        /* 5. CTA Button (Luxury Gold Background) */
        /* ------------------------------------- */
        .cta-button {
            /* Metallic gradient background */
            background: linear-gradient(145deg, var(--color-gold-luxury) 0%, var(--color-brass-antique) 100%);
            border: 3px solid var(--color-gold-luxury); 
            
            /* Engraved text effect */
            color: var(--color-bg-main);
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.2); 
            
            /* Initial shadow for depth */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            font-weight: 800; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .cta-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02); 
            /* Stronger external gold glow */
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.7), 0 0 30px var(--color-gold-luxury); 
            color: var(--color-bg-main);
        }
        
        .cta-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    </style>
    <script>
        // Set Tailwind config to use CSS variables
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'charcoal': 'var(--color-bg-main)',
                        'deep-brown': 'var(--color-bg-secondary)',
                        'cream-white': 'var(--color-text-cream)',
                        'luxury-gold': 'var(--color-gold-luxury)',
                        'antique-brass': 'var(--color-brass-antique)',
                        'danger-red': 'var(--color-danger)',
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen christmas-bg flex flex-col items-center p-4 sm:p-8">

    <!-- Twinkling Stars Background Animation (40 stars) -->
    <div class="star-twinkle" style="top: 6%; left: 82%; animation-delay: 0.1s; animation-duration: 2.5s;"></div>
    <div class="star-twinkle" style="top: 16%; left: 3%; animation-delay: 1.2s; animation-duration: 1.8s;"></div>
    <div class="star-twinkle" style="top: 92%; left: 96%; animation-delay: 0.5s; animation-duration: 3.0s;"></div>
    <div class="star-twinkle" style="top: 51%; left: 31%; animation-delay: 2.1s; animation-duration: 2.0s;"></div>
    <div class="star-twinkle" style="top: 76%; left: 9%; animation-delay: 0.8s; animation-duration: 1.4s;"></div>
    <div class="star-twinkle" style="top: 24%; left: 71%; animation-delay: 3.5s; animation-duration: 2.2s;"></div>
    <div class="star-twinkle" style="top: 86%; left: 49%; animation-delay: 1.7s; animation-duration: 2.8s;"></div>
    <div class="star-twinkle" style="top: 11%; left: 39%; animation-delay: 0.3s; animation-duration: 1.6s;"></div>
    <div class="star-twinkle" style="top: 61%; left: 66%; animation-delay: 2.5s; animation-duration: 1.9s;"></div>
    <div class="star-twinkle" style="top: 44%; left: 91%; animation-delay: 0.9s; animation-duration: 2.6s;"></div>
    <div class="star-twinkle" style="top: 4%; left: 19%; animation-delay: 2.8s; animation-duration: 1.5s;"></div>
    <div class="star-twinkle" style="top: 81%; left: 6%; animation-delay: 0.4s; animation-duration: 2.1s;"></div>
    <div class="star-twinkle" style="top: 21%; left: 94%; animation-delay: 1.9s; animation-duration: 1.7s;"></div>
    <div class="star-twinkle" style="top: 36%; left: 54%; animation-delay: 3.2s; animation-duration: 2.3s;"></div>
    <div class="star-twinkle" style="top: 71%; left: 34%; animation-delay: 0.6s; animation-duration: 1.3s;"></div>
    <div class="star-twinkle" style="top: 56%; left: 84%; animation-delay: 1.5s; animation-duration: 2.4s;"></div>
    <div class="star-twinkle" style="top: 29%; left: 14%; animation-delay: 2.3s; animation-duration: 1.6s;"></div>
    <div class="star-twinkle" style="top: 66%; left: 76%; animation-delay: 0.2s; animation-duration: 2.7s;"></div>
    <div class="star-twinkle" style="top: 14%; left: 51%; animation-delay: 1.8s; animation-duration: 1.9s;"></div>
    <div class="star-twinkle" style="top: 89%; left: 24%; animation-delay: 3.0s; animation-duration: 2.0s;"></div>
    <div class="star-twinkle" style="top: 3%; left: 60%; animation-delay: 0.7s; animation-duration: 1.5s;"></div>
    <div class="star-twinkle" style="top: 95%; left: 15%; animation-delay: 2.9s; animation-duration: 2.0s;"></div>
    <div class="star-twinkle" style="top: 40%; left: 88%; animation-delay: 0.4s; animation-duration: 2.6s;"></div>
    <div class="star-twinkle" style="top: 7%; left: 33%; animation-delay: 1.1s; animation-duration: 1.7s;"></div>
    <div class="star-twinkle" style="top: 48%; left: 5%; animation-delay: 3.3s; animation-duration: 2.1s;"></div>
    <div class="star-twinkle" style="top: 28%; left: 42%; animation-delay: 1.0s; animation-duration: 1.5s;"></div>
    <div class="star-twinkle" style="top: 84%; left: 78%; animation-delay: 2.2s; animation-duration: 2.9s;"></div>
    <div class="star-twinkle" style="top: 18%; left: 23%; animation-delay: 0.0s; animation-duration: 1.3s;"></div>
    <div class="star-twinkle" style="top: 73%; left: 68%; animation-delay: 1.6s; animation-duration: 2.5s;"></div>
    <div class="star-twinkle" style="top: 58%; left: 98%; animation-delay: 3.4s; animation-duration: 1.9s;"></div>
    <div class="star-twinkle" style="top: 38%; left: 8%; animation-delay: 0.5s; animation-duration: 2.2s;"></div>
    <div class="star-twinkle" style="top: 64%; left: 52%; animation-delay: 2.7s; animation-duration: 1.8s;"></div>
    <div class="star-twinkle" style="top: 8%; left: 90%; animation-delay: 1.4s; animation-duration: 2.4s;"></div>
    <div class="star-twinkle" style="top: 91%; left: 38%; animation-delay: 0.9s; animation-duration: 1.6s;"></div>
    <div class="star-twinkle" style="top: 42%; left: 73%; animation-delay: 2.0s; animation-duration: 2.7s;"></div>
    <div class="star-twinkle" style="top: 20%; left: 62%; animation-delay: 3.6s; animation-duration: 1.5s;"></div>
    <div class="star-twinkle" style="top: 53%; left: 25%; animation-delay: 0.3s; animation-duration: 3.1s;"></div>
    <div class="star-twinkle" style="top: 77%; left: 80%; animation-delay: 1.3s; animation-duration: 1.4s;"></div>
    <div class="star-twinkle" style="top: 97%; left: 57%; animation-delay: 2.6s; animation-duration: 2.3s;"></div>
    <div class="star-twinkle" style="top: 32%; left: 99%; animation-delay: 0.7s; animation-duration: 2.0s;"></div>


    <!-- Main content container (RWD class optimization) -->
    <!-- Max width adjusted: full width on mobile, max-w-lg on larger screens by default -->
    <!-- Added id 'app-container' for dynamic content injection -->
    <div id="app-container" class="w-full max-w-screen-md lg:max-w-lg my-auto py-8 px-6 glass-card rounded-2xl">
        <!-- é€™æ˜¯ç­‰å¾… Firebase æ™‚é¡¯ç¤ºçš„é è¨­å…§å®¹ -->
        <div class="text-center py-10">
            <h2 class="font-luxury-heading text-2xl" style="color:var(--color-gold-luxury);">
                è¼‰å…¥ä¸­... è–èª•è€äººåœ¨è·¯ä¸Šï¼
            </h2>
            <p class="mt-2 text-sm text-cream-white/70">
                å¦‚æœé•·æ™‚é–“æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚
            </p>
        </div>
    </div>
    <div id="debug-info" class="text-xs text-cream-white/50 mt-4 text-center"></div>

    <script>
        // Set Tailwind config to use CSS variables
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'charcoal': 'var(--color-bg-main)',
                        'deep-brown': 'var(--color-bg-secondary)',
                        'cream-white': 'var(--color-text-cream)',
                        'luxury-gold': 'var(--color-gold-luxury)',
                        'antique-brass': 'var(--color-brass-antique)',
                        'danger-red': 'var(--color-danger)',
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                    },
                }
            }
        }
    </script>
    <script>
        // Application state
        const state = {
            currentPage: 'home', // 'home', 'form', 'success'
            formData: {
                paymentProof: '',
                name: '',
                contact: '',
                dressCodeConfirmed: false,
                ktvWish: '',
                diet_noBeef: false,
                diet_noAlcohol: false,
                diet_vegetarian: '', // ç´ é£Ÿé¡å‹
                diet_other: ''
            },
            errorMessage: '',
            submissionId: null
        };

        // Helper function: Render icon
        function renderIcon(name, classes = 'w-5 h-5 inline mr-2') {
            // Icon uses luxury gold
            return `<i data-lucide="${name}" class="${classes}" style="color:var(--color-gold-luxury);"></i>`;
        }

        // Helper function: Update page content
        function updatePage() {
            const container = document.getElementById('app-container');
            const debugInfo = document.getElementById('debug-info');

            // Set initial class list if it's the first render
            if (container.classList.length === 0) {
                 container.className = "w-full max-w-screen-md lg:max-w-lg my-auto py-8 px-6 glass-card rounded-2xl";
            }
            
            container.innerHTML = '';
            state.errorMessage = '';
            
            // Clear all dynamic max-width classes first
            container.classList.remove('md:max-w-4xl', 'md:max-w-lg'); 

            switch (state.currentPage) {
                case 'home':
                    renderHome(container);
                    break;
                case 'form':
                    renderForm(container);
                    break;
                case 'success':
                    renderSuccess(container);
                    break;
            }
            
            // Re-render Lucide icons
            lucide.createIcons();

            // Display debug info at the bottom for troubleshooting
            debugInfo.innerHTML = `Auth Status: ${window.app.isSubmissionEnabled ? '<span style="color:#22c55e;">å·²é€£ç·š (å¯æäº¤)</span>' : '<span style="color:var(--color-danger);">æœªé€£ç·š (ç„¡æ³•æäº¤)</span>'} | User ID: ${window.userId || 'N/A'}`;
        }

        // --- Page rendering logic ---

        // Hero Page (Home)
        function renderHome(container) {
            // RWD Enhancement: Use larger max-width for Home page layout on medium/large screens
            container.classList.add('md:max-w-4xl', 'text-center');

            const isEnabled = window.app.isSubmissionEnabled;

            container.innerHTML = `
                <!-- RWD Typography: text-4xl on mobile, 5xl on medium screens, 6xl on large screens -->
                <h1 class="font-luxury-heading text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-4 pt-2" style="color:var(--color-gold-luxury); text-shadow: 1px 1px 10px rgba(0,0,0,1);">
                    Kæ­Œè–èª•ç¦®ç‰©è¶´
                </h1>
                <!-- RWD Typography: text-lg on mobile, text-xl on larger screens -->
                <p class="text-lg sm:text-xl mb-8 text-cream-white">
                    2025/12/19ï¼ˆäº”ï¼‰19:00â€“23:00ï½œéŒ¢æ«ƒä¸­è¯æ–°é¤¨
                </p>
                
                <!-- CTA Button -->
                <button id="cta-button" 
                        class="cta-button text-xl sm:text-2xl font-bold py-3 px-10 rounded-full mb-10 mx-auto" 
                        onclick="state.currentPage='form'; updatePage();"
                        ${!isEnabled ? 'disabled' : ''}>
                    ${isEnabled ? 'æ¶éº¥å…¥å ´ï¼' : 'è³‡æ–™åº«é€£ç·šä¸­...'}
                </button>
                ${!isEnabled ? '<p class="text-sm text-danger-red mb-4">è³‡æ–™åº«ä»åœ¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™å†é»æ“Šã€‚</p>' : ''}


                <!-- Party Info Area (RWD: single column on mobile, two columns on medium screens) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left text-cream-white mt-4">
                    
                    <!-- Rules Card -->
                    <div class="p-4 glass-card rounded-xl">
                        <!-- RWD Typography: text-base on mobile, text-lg on larger screens -->
                        <h2 class="font-luxury-heading text-base sm:text-lg font-semibold mb-2" style="color:var(--color-gold-luxury);">
                            ${renderIcon('user-check', 'w-4 h-4 inline mr-1')}åé¡èˆ‡è²»ç”¨
                        </h2>
                        <p class="mb-2 text-sm sm:text-base">åé¡ï¼š8â€“12 ä½</p>
                        <p class="text-sm sm:text-base">è²»ç”¨ï¼šNT$ 500 è¨‚é‡‘ (æ´»å‹•å¾Œå¤šé€€å°‘è£œ)</p>
                        <p class="mt-2 text-xs sm:text-sm" style="color:var(--color-gold-luxury);">* è«‹å…ˆä»˜æ¬¾å†å¡«å¯«å ±åè¡¨ã€‚</p>
                    </div>

                    <!-- Gift and Dress Card -->
                    <div class="p-4 glass-card rounded-xl">
                        <!-- RWD Typography: text-base on mobile, text-lg on larger screens -->
                        <h2 class="font-luxury-heading text-base sm:text-lg font-semibold mb-2" style="color:var(--color-gold-luxury);">
                            ${renderIcon('gift', 'w-4 h-4 inline mr-1')}ç¦®ç‰©èˆ‡æœè£
                        </h2>
                        <p class="mb-2 text-sm sm:text-base"><strong>Dress Code:</strong> ç©¿è‘—<strong style="color:var(--color-gold-luxury);">ç´…</strong>æˆ–<strong style="color:var(--color-brass-antique);">ç¶ </strong>å…ƒç´ ã€‚</p>
                        <p class="text-sm sm:text-base"><strong>äº¤æ›ç¦®ç‰©:</strong> NT$ 300â€“500ï¼Œå¯¦ç”¨æ€§å–å‘ã€‚</p>
                    </div>
                </div>
            `;
        }

        // Form Page (Form)
        function renderForm(container) {
            // RWD Enhancement: Revert to a smaller max width for forms
            container.classList.add('md:max-w-lg');
            
            const isEnabled = window.app.isSubmissionEnabled;

            container.innerHTML = `
                <!-- RWD Typography: text-2xl on mobile, 3xl on larger screens -->
                <h2 class="font-luxury-heading text-2xl sm:text-3xl font-bold mb-6 text-center" style="color:var(--color-gold-luxury);">
                    ${renderIcon('clipboard-list')}æ¬²åƒåŠ è€…ï¼Œæ•¬è«‹å¡«å¯«ä¸‹æ–¹å ±åè¡¨
                </h2>
                ${state.errorMessage ? `<div class="p-3 mb-4 rounded-lg text-sm text-center" style="background-color:var(--color-danger); color: var(--color-text-cream);">${state.errorMessage}</div>` : ''}
                ${!isEnabled ? '<div class="p-3 mb-4 rounded-lg text-sm text-center bg-yellow-600/50 text-cream-white">ğŸš¨ æ³¨æ„ï¼šè³‡æ–™åº«é€£ç·šä¸ç©©å®šï¼Œå ±åè¡¨é€å‡ºå¯èƒ½å¤±æ•—ã€‚</div>' : ''}


                <form id="registration-form" onsubmit="event.preventDefault(); submitForm();">
                    
                    <!-- Step 1: Deposit Payment Card -->
                    <div class="p-6 mb-8 rounded-xl glass-card border-2" style="border-color:var(--color-gold-luxury);">
                        <!-- RWD Typography: text-lg on mobile, 2xl on larger screens -->
                        <h3 class="font-luxury-heading text-lg sm:text-xl font-bold mb-4" style="color:var(--color-gold-luxury);">
                            ${renderIcon('credit-card')}æ­¥é©Ÿä¸€ï¼šé ä»˜æ´»å‹•è¨‚é‡‘
                        </h3>
                        <div class="text-center mb-4">
                            <!-- RWD Typography: 4xl on mobile, 5xl on larger screens -->
                            <span class="font-luxury-heading text-4xl sm:text-5xl font-extrabold" style="color:var(--color-gold-luxury); text-shadow: 2px 2px 5px rgba(0,0,0,0.7);">
                                NT$ 500
                            </span>
                        </div>
                        <p class="text-cream-white mb-2 text-sm">ï¼ˆè«‹å…ˆå®Œæˆä»˜æ¬¾ï¼Œå†å¡«å¯«ä¸‹æ–¹è¡¨å–®ï¼ï¼‰</p>
                        <p class="mt-2 text-xs sm:text-sm" style="color:var(--color-gold-luxury);">* æº«é¦¨æç¤ºï¼šè¨‚é‡‘å°‡æ–¼æ´»å‹•çµæŸå¾Œä¾å¯¦éš›æ¶ˆè²»è¨ˆç®—ï¼Œæ¡å¤šé€€å°‘è£œåŸå‰‡ã€‚</p>
                        <!-- Payment info placeholder -->
                        <p class="text-xs mt-3 text-cream-white/70">
                            æ”¯ä»˜æ–¹å¼ï¼šLINE Pay / éŠ€è¡Œè½‰å¸³ (è«‹å‘ä¸»è¾¦äººç¢ºèªå¸³è™Ÿè³‡è¨Š)
                        </p>
                    </div>

                    <!-- Step 2: Registration Data -->
                    <div class="space-y-6">
                        <!-- RWD Typography: text-base on mobile, text-lg on larger screens -->
                        <div class="font-luxury-heading text-base sm:text-lg font-semibold" style="color:var(--color-brass-antique);">
                            ${renderIcon('user-circle')}å ±åè€…è³‡æ–™
                        </div>
                        
                        <!-- Required Fields (Inputs are w-full by default, which is good for RWD) -->
                        <div>
                            <label for="paymentProof" class="block text-sm font-medium text-cream-white/80 mb-1">ä»˜æ¬¾è­‰æ˜å¾Œäº”ç¢¼/æš±ç¨± <span style="color:var(--color-danger);">*</span></label>
                            <input type="text" id="paymentProof" name="paymentProof" value="${state.formData.paymentProof}" oninput="state.formData.paymentProof = this.value" class="glass-input w-full p-2" placeholder="è«‹å¡«å¯«è½‰å¸³å¾Œäº”ç¢¼æˆ– LINE Pay æš±ç¨±" required>
                        </div>
                        <div>
                            <label for="name" class="block text-sm font-medium text-cream-white/80 mb-1">å§“å/æš±ç¨± <span style="color:var(--color-danger);">*</span></label>
                            <input type="text" id="name" name="name" value="${state.formData.name}" oninput="state.formData.name = this.value" class="glass-input w-full p-2" placeholder="æ´¾å°ä¸Šå¸Œæœ›è¢«ç¨±å‘¼çš„åå­—" required>
                        </div>
                        <div>
                            <label for="contact" class="block text-sm font-medium text-cream-white/80 mb-1">è¯çµ¡æ–¹å¼ (LINE ID/Instrangeå¸³è™Ÿ) <span style="color:var(--color-danger);">*</span></label>
                            <input type="text" id="contact" name="contact" value="${state.formData.contact}" oninput="state.formData.contact = this.value" class="glass-input w-full p-2" placeholder="æ–¹ä¾¿ä¸»è¾¦äººè¯ç¹«çš„ LINE ID æˆ– IG å¸³è™Ÿ" required>
                        </div>

                        <!-- Dress Code Confirmation -->
                        <div class="flex items-center pt-2">
                            <input type="checkbox" id="dressCodeConfirmed" name="dressCodeConfirmed" ${state.formData.dressCodeConfirmed ? 'checked' : ''} onchange="state.formData.dressCodeConfirmed = this.checked" class="glass-check w-4 h-4 mr-3 cursor-pointer">
                            <label for="dressCodeConfirmed" class="text-sm font-medium" style="color:var(--color-gold-luxury);">
                                ${renderIcon('check-circle', 'w-4 h-4 inline mr-1')}æˆ‘å·²ç¢ºèªä¸¦æœƒéµå®ˆã€Œç´…æˆ–ç¶ ã€æœè£è¦å®š <span style="color:var(--color-danger);">*</span>
                            </label>
                        </div>

                        <hr class="border-t border-white/20 my-6">

                        <!-- Optional: KTV Wish -->
                        <div>
                            <label for="ktvWish" class="block text-sm font-medium text-cream-white/80 mb-1">
                                ${renderIcon('music')} KTV é»æ­Œè¨±é¡˜ (é¸å¡«)
                            </label>
                            <input type="text" id="ktvWish" name="ktvWish" value="${state.formData.ktvWish}" oninput="state.formData.ktvWish = this.value" class="glass-input w-full p-2" placeholder="æƒ³è½æˆ–æƒ³å”±çš„æ­Œæ›²åç¨±">
                        </div>

                        <!-- Optional: Dietary Preferences -->
                        <div class="pt-2">
                            <label class="block text-sm font-medium text-cream-white/80 mb-2 font-luxury-heading">
                                ${renderIcon('utensils')} é¤é£²åå¥½ (è«‹å‹¾é¸ï¼Œé»é¤æœƒåƒè€ƒ)
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center text-sm text-cream-white">
                                    <input type="checkbox" name="diet" value="noBeef" ${state.formData.diet_noBeef ? 'checked' : ''} onchange="state.formData.diet_noBeef = this.checked" class="glass-check w-4 h-4 mr-2 cursor-pointer">
                                    ä¸åƒç‰›
                                </label>
                                <label class="flex items-center text-sm text-cream-white">
                                    <input type="checkbox" name="diet" value="noAlcohol" ${state.formData.diet_noAlcohol ? 'checked' : ''} onchange="state.formData.diet_noAlcohol = this.checked" class="glass-check w-4 h-4 mr-2 cursor-pointer">
                                    ä¸å–é…’
                                </label>
                                <div class="ml-6">
                                    <label for="diet_vegetarian" class="block text-sm font-medium text-cream-white/70 mb-1 mt-2">ç´ é£Ÿé¡å‹ (è‹¥ç‚ºç´ é£Ÿè€…)</label>
                                    <input type="text" id="diet_vegetarian" name="diet_vegetarian" value="${state.formData.diet_vegetarian}" oninput="state.formData.diet_vegetarian = this.value" class="glass-input w-full p-2 text-xs" placeholder="ä¾‹å¦‚ï¼šè›‹å¥¶ç´ /é‹é‚Šç´ /å…¨ç´ ">
                                </div>
                                <div>
                                    <label for="diet_other" class="block text-sm font-medium text-cream-white/70 mb-1 mt-2">å…¶ä»–éæ•/ç¦å¿Œ (é–‹æ”¾æ¬„ä½)</label>
                                    <input type="text" id="diet_other" name="diet_other" value="${state.formData.diet_other}" oninput="state.formData.diet_other = this.value" class="glass-input w-full p-2 text-xs" placeholder="ä¾‹å¦‚ï¼šèŠ±ç”Ÿéæ•ã€ä¸åƒæµ·é®®ç­‰">
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-xs text-center mt-6 mb-2 text-cream-white/70">
                        ï¼ˆå¡«å¯«å®Œæˆå¾Œï¼Œè«‹ç•™æ„è·³å‡ºçš„é é¢ï¼Œå…§å«ç•¶å¤©é€²å ´çš„ IG ç¾¤çµ„é€£çµå–”ï¼ï¼‰
                    </p>

                    <!-- RWD Typography: text-lg on mobile, xl on larger screens -->
                    <button type="submit" 
                            class="cta-button w-full text-lg sm:text-xl font-bold py-3 px-10 rounded-full mt-6"
                            ${!isEnabled ? 'disabled' : ''}>
                        é€å‡ºå ±å
                    </button>
                    ${!isEnabled ? '<p class="text-sm text-danger-red mt-2 text-center">** è³‡æ–™åº«æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºå ±å **</p>' : ''}

                </form>
            `;
        }

        // Success Page (Success)
        function renderSuccess(container) {
            // RWD Enhancement: Revert to a smaller max width for focus
            container.classList.add('md:max-w-lg');

            // Use the new IG link
            const igLink = "https://ig.me/j/AbZP3xD1ugaWGDMX/";

            container.innerHTML = `
                <!-- RWD Typography: 3xl on mobile, 4xl on larger screens -->
                <h2 class="font-luxury-heading text-3xl sm:text-4xl font-extrabold mb-6" style="color:var(--color-gold-luxury); text-shadow: 2px 2px 5px rgba(0,0,0,0.7);">
                    ğŸ‰ æ­å–œï¼æ¶éº¥å…¥å ´æˆåŠŸï¼
                </h2>
                <p class="text-lg sm:text-xl mb-8 text-cream-white">
                    æ‚¨çš„åé¡å·²ä¿ç•™ã€‚æˆ‘å€‘éå¸¸æœŸå¾…èˆ‡æ‚¨åœ¨ KTV ç‹‚æ­¡ï¼
                </p>
                <div class="text-xs text-cream-white/70 mb-4">
                    æ‚¨çš„å ±åç·¨è™Ÿ (ç”¨æ–¼é©—è­‰)ï¼š${state.submissionId || 'N/A (è«‹æˆªåœ–æ­¤é é¢)'}
                </div>


                <!-- IG Group CTA: RWD Typography: text-xl on mobile, 2xl on larger screens -->
                <a href="${igLink}" target="_blank" class="block text-xl sm:text-2xl font-bold py-4 px-10 rounded-full mb-10 mx-auto" style="background-color:var(--color-gold-luxury); color:var(--color-bg-main); border: 3px solid var(--color-brass-antique); transition: all 0.3s ease;">
                    ${renderIcon('instagram', 'w-6 h-6 inline mr-3')}ç«‹å³åŠ å…¥ IG æ´¾å°ç¾¤çµ„
                </a>
                <p class="text-sm text-cream-white/80 mb-8">
                    ï¼ˆè«‹å‹™å¿…åŠ å…¥ç¾¤çµ„ï¼Œä»¥ä¾¿è¯ç¹«ã€ç™¼å¸ƒåŒ…å»‚è™Ÿç¢¼åŠçªç™¼ç‹€æ³é€šçŸ¥ã€‚ï¼‰
                </p>

                <!-- Location Info -->
                <div class="glass-card p-4 rounded-xl mb-8 text-left text-cream-white">
                    <h3 class="font-luxury-heading text-lg font-semibold mb-3" style="color:var(--color-gold-luxury);">
                        ${renderIcon('map-pin')}æ´»å‹•åœ°é»ï¼šéŒ¢æ«ƒä¸­è¯æ–°é¤¨
                    </h3>
                    <!-- Map Embed (Responsive Aspect Ratio) -->
                    <div class="aspect-w-16 aspect-h-9 w-full rounded-lg overflow-hidden">
                        <iframe
                          src="https://maps.google.com/?cid=14928216406343438233&hl=zh-TW&output=embed"
                          width="100%"
                          height="300"
                          style="border:0; border-radius: 10px;"
                          allowfullscreen=""
                          loading="lazy"
                          referrerpolicy="no-referrer-when-downgrade"
                        ></iframe>
                    </div>
                </div>
            `;
        }

        // Form submission logic
        async function submitForm() {
            const form = document.getElementById('registration-form');
            if (!window.app.isSubmissionEnabled) {
                 state.errorMessage = 'ğŸš¨ è³‡æ–™åº«å°šæœªé€£ç·šï¼Œç„¡æ³•æäº¤å ±åï¼è«‹ç¨å¾Œå†è©¦ã€‚';
                 updatePage();
                 return;
            }

            // Check if all required fields are filled and dress code is confirmed
            if (!form.checkValidity() || !state.formData.dressCodeConfirmed) {
                state.errorMessage = 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ä¸¦ç¢ºèª Dress Code è¦å®šï¼';
                updatePage();
                return;
            }

            try {
                // Show loading state (optional: disable button)
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.textContent = 'æäº¤ä¸­...';
                submitButton.disabled = true;

                // Clean and prepare data to be saved
                const dataToSave = {
                    name: state.formData.name,
                    contact: state.formData.contact,
                    paymentProof: state.formData.paymentProof,
                    dressCodeConfirmed: state.formData.dressCodeConfirmed,
                    ktvWish: state.formData.ktvWish || 'ç„¡',
                    giftValue: 'NT$ 300â€“500', // Save the current gift value
                    diet: {
                        noBeef: state.formData.diet_noBeef,
                        noAlcohol: state.formData.diet_noAlcohol,
                        vegetarian: state.formData.diet_vegetarian || 'ç„¡',
                        other: state.formData.diet_other || 'ç„¡'
                    }
                };

                const submissionId = await window.firebase.saveRegistration(dataToSave);
                state.submissionId = submissionId;
                state.currentPage = 'success';
                updatePage();

            } catch (error) {
                console.error("Submission failed:", error);
                // Re-enable button and reset text
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.textContent = 'é€å‡ºå ±å';
                submitButton.disabled = false;
                
                state.errorMessage = 'å ±åå¤±æ•—ï¼Œå¯èƒ½åŸå› ï¼šFirebaseé€£ç·šå•é¡Œæˆ–ç¶²è·¯ç•°å¸¸ã€‚';
                updatePage();
            }
        }
    </script>
</body>
</html>